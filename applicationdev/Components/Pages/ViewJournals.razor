@page "/journals"

@using applicationdev.ModelDirectory
@using applicationdev.ServicesDirectory
@inject IJournalService JournalService
@inject IStoreUserService StoreUser
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Microsoft.Maui.Storage;

<h3>My Journals</h3>

<!-- Filters Row -->
<div class="row mb-3 g-2">
    <div class="col-md-3">
        <input class="form-control"
               placeholder="Search by content..."
               @bind="searchContent"
               @bind:event="oninput" />
    </div>

    <div class="col-md-2">
        <input type="date" class="form-control" @bind="fromDate" />
    </div>

    <div class="col-md-2">
        <input type="date" class="form-control" @bind="toDate" />
    </div>

    <div class="col-md-2">
        <select class="form-select" @bind="selectedMoodId">
            <option value="">-- Filter by Mood --</option>
            @foreach (var m in moods)
            {
                <option value="@m.MoodKey">@m.MoodTitle (@m.Category)</option>
            }
        </select>
    </div>

    <div class="col-md-2">
        <select class="form-select" @bind="selectedTagId">
            <option value="">-- Filter by Tag --</option>
            @foreach (var t in tags)
            {
                <option value="@t.TagKey">@t.TagTitle</option>
            }
        </select>
    </div>

    <div class="col-md-1 d-flex flex-column gap-1">
        <button class="btn btn-success w-100" @onclick="DownloadPdfForDateRange">
            Export PDF
        </button>
        <button class="btn btn-secondary w-100" @onclick="ApplyFilters">
            Apply
        </button>
    </div>
</div>

<!-- Journal List -->
@if (pagedJournals == null)
{
    <p>Loading...</p>
}
else if (!pagedJournals.Any())
{
    <p>No journals found!</p>
}
else
{
    <div class="list-group mb-3">
        @foreach (var j in pagedJournals)
        {
            <button class="list-group-item list-group-item-action text-start"
                    @onclick="() => ToggleJournal(j.JournalId)">

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@j.JournalDate.ToString("dd/MM/yyyy")</strong> |
                         Primary mood: @j.MainMood?.MoodTitle
                    </div>

                    <div>
                        <button class="btn btn-sm btn-warning me-2"
                                @onclick:stopPropagation="true"
                                @onclick="() => EditJournal(j.JournalId)">
                            Edit
                        </button>

                        <button class="btn btn-sm btn-danger me-2"
                                @onclick:stopPropagation="true"
                                @onclick="() => DeleteJournal(j.JournalId)">
                            Delete
                        </button>

                        <button class="btn btn-sm btn-info"
                                @onclick:stopPropagation="true"
                                @onclick="() => DownloadPdf(j)">
                            PDF
                        </button>
                    </div>
                </div>

                @if (expandedJournalId == j.JournalId)
                {
                    <div class="mt-2 border-top pt-2">
                        <p>
                            <b>Secondary Mood:</b> 
                            @(j.ExtraMoods.Any() 
                                ? string.Join(", ", j.ExtraMoods.Select(m => m.RelatedMood.MoodTitle)) 
                                : "None")
                        </p>
                        <p>
                            <b>Tags:</b> 
                            @(j.EntryTags.Any() 
                                ? string.Join(", ", j.EntryTags.Select(t => t.RelatedTag.TagTitle)) 
                                : "None")
                        </p>
                        <p><b>Word Count:</b> @j.TotalWordCount</p>
                        <div>@((MarkupString)j.BodyText)</div>
                    </div>

                }
            </button>
        }
    </div>

    <!-- Pagination -->
    <nav>
        <ul class="pagination">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="PrevPage">Previous</button>
            </li>
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="NextPage">Next</button>
            </li>
        </ul>
    </nav>
}

@code {
    // --- Data ---
    private List<JournalEntry> journals = new();
    private List<JournalEntry> filteredJournals = new();
    private List<JournalEntry> pagedJournals = new();

    private List<Mood> moods = new();
    private List<Tag> tags = new();

    private int? expandedJournalId;

    // --- Pagination ---
    private int currentPage = 1;
    private int pageSize = 4;
    private int totalPages => (int)Math.Ceiling((double)filteredJournals.Count / pageSize);

    // --- Filters ---
    private string searchContent = "";
    private int? selectedMoodId;
    private int? selectedTagId;
    private DateTime? fromDate;
    private DateTime? toDate;

    protected override async Task OnInitializedAsync()
    {
        var userId = StoreUser.UserId;

        journals = (await JournalService.GetAllJournalsAsync())
            .Where(j => j.OwnerId == userId)
            .OrderByDescending(j => j.JournalDate)
            .ToList();

        moods = journals.Select(j => j.MainMood).Where(m => m != null).Distinct().ToList();
        tags = journals.SelectMany(j => j.EntryTags.Select(t => t.RelatedTag)).Distinct().ToList();

        filteredJournals = new List<JournalEntry>(journals);
        ApplyPagination();
    }

    // --- Toggle Expand ---
    private void ToggleJournal(int id) =>
        expandedJournalId = expandedJournalId == id ? null : id;

    private void EditJournal(int id) =>
        Nav.NavigateTo($"/addjournal/{id}");

    private async Task DeleteJournal(int id)
    {
        await JournalService.DeleteJournalAsync(id);
        journals.RemoveAll(j => j.JournalId == id);
        ApplyFilters();
    }

    // --- Filters & Pagination ---
    private void ApplyFilters()
    {
        filteredJournals = journals;

        if (!string.IsNullOrWhiteSpace(searchContent))
            filteredJournals = filteredJournals
                .Where(j => j.BodyText.Contains(searchContent, StringComparison.OrdinalIgnoreCase))
                .ToList();

        if (fromDate.HasValue)
            filteredJournals = filteredJournals
                .Where(j => j.JournalDate.Date >= fromDate.Value.Date)
                .ToList();

        if (toDate.HasValue)
            filteredJournals = filteredJournals
                .Where(j => j.JournalDate.Date <= toDate.Value.Date)
                .ToList();

        if (selectedMoodId.HasValue)
            filteredJournals = filteredJournals
                .Where(j => j.MainMoodId == selectedMoodId)
                .ToList();

        if (selectedTagId.HasValue)
            filteredJournals = filteredJournals
                .Where(j => j.EntryTags.Any(t => t.RelatedTagId == selectedTagId))
                .ToList();

        currentPage = 1;
        ApplyPagination();
    }

    private void ApplyPagination()
    {
        pagedJournals = filteredJournals
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            ApplyPagination();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            ApplyPagination();
        }
    }

    // ================= PDF SECTION =================

    // Single Journal PDF
    private async Task DownloadPdf(JournalEntry journal)
    {
        try
        {
            var html = GenerateJournalHtml(journal);
            await GenerateAndOpenPdf(html, $"Journal_{journal.JournalDate:yyyyMMdd}.pdf");
        }
        catch (Exception ex)
        {
            Console.WriteLine("PDF Error: " + ex.Message);
        }
    }

    // Date Range PDF
    private async Task DownloadPdfForDateRange()
    {
        if (fromDate == null || toDate == null)
        {
            Console.WriteLine("Please select a valid date range.");
            return;
        }

        var journalsInRange = filteredJournals
            .Where(j => j.JournalDate.Date >= fromDate.Value.Date &&
                        j.JournalDate.Date <= toDate.Value.Date)
            .OrderBy(j => j.JournalDate)
            .ToList();

        if (!journalsInRange.Any())
        {
            Console.WriteLine("No journals found in this date range.");
            return;
        }

        var html = @"<div style='margin:20px; font-family:Arial, sans-serif;'>";

        foreach (var journal in journalsInRange)
        {
            html += GenerateJournalHtml(journal);
        }

        html += "</div>";

        await GenerateAndOpenPdf(html, $"Journals_{fromDate:yyyyMMdd}_{toDate:yyyyMMdd}.pdf");
    }

    private string GenerateJournalHtml(JournalEntry journal)
    {
        var secondaryMoods = journal.ExtraMoods.Any()
            ? string.Join(", ", journal.ExtraMoods.Select(m => m.RelatedMood.MoodTitle))
            : "None";

        var tagList = journal.EntryTags.Any()
            ? string.Join(", ", journal.EntryTags.Select(t => t.RelatedTag.TagTitle))
            : "None";

        return $@"
<div style='margin:25px 0; padding:20px; border:2px solid #4f46e5; background:#f5f7ff; border-radius:10px; font-family:Arial, sans-serif;'>

    <!-- Header -->
    <div style='background:#4f46e5; color:white; padding:10px 15px; border-radius:6px;'>
        <h3 style='margin:0;'>Journal Entry</h3>
        <small>Date: {journal.JournalDate:yyyy-MM-dd}</small>
    </div>

    <!-- Info Section -->
    <div style='margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:14px;'>
        <p><b style='color:#4f46e5;'>Primary Mood:</b> {journal.MainMood?.MoodTitle}</p>
        <p><b style='color:#4f46e5;'>Secondary Moods:</b> {secondaryMoods}</p>
        <p><b style='color:#4f46e5;'>Tags:</b> {tagList}</p>
        <p><b style='color:#4f46e5;'>Word Count:</b> {journal.TotalWordCount}</p>
    </div>

    <hr style='margin:15px 0; border:1px solid #ddd;' />

    <!-- Body -->
    <div style='background:white; padding:15px; border-radius:6px; line-height:1.6; font-size:15px; color:#333;'>
        {journal.BodyText}
    </div>

</div>";
    }

    private async Task GenerateAndOpenPdf(string html, string fileName)
    {
        try
        {
            var base64 = await JS.InvokeAsync<string>("pdfExporter.createPdfBase64", html);

            if (!string.IsNullOrEmpty(base64))
            {
                byte[] pdfBytes = Convert.FromBase64String(base64);

                var filePath = Path.Combine(FileSystem.CacheDirectory, fileName);

                await File.WriteAllBytesAsync(filePath, pdfBytes);

         
                await Launcher.Default.OpenAsync(new OpenFileRequest
                {
                    File = new ReadOnlyFile(filePath)
                });

                Console.WriteLine($"PDF saved to: {filePath}");
            }
            else
            {
                Console.WriteLine("PDF generation failed or returned empty.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("PDF open error: " + ex.Message);
        }
    }


}
